{% extends 'base.html' %}

{% block title %}Belt Conveyor - My Project{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4 text-center">Belt Conveyor</h1>

    <div class="row">
        <!-- Input Section -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">Inputs</div>
                <div class="card-body">
                    <form id="inputForm">
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">Belt Length</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="beltlength" value="7000" style="color: blue;" />
                            </div>
                        </div>
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">Belt Width</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="beltwidth" value="800" style="color: blue;" />
                            </div>
                        </div>
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">Drum Diameter</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="drumdiameter" value="250" style="color: blue;" />
                            </div>
                        </div>
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">Friction</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="friction" value="0.3" style="color: blue;" />
                            </div>
                        </div>
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">Velocity</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="velocity" value="0.4" style="color: blue;" />
                            </div>
                        </div>
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">Factor of Safety</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="factorofsafety" value="1.5" style="color: blue;" />
                            </div>
                        </div>
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">Belt weight per meter</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="beltweightpermeter" value="15" style="color: blue;" />
                            </div>
                        </div>
                        <div class="mb-1 row">
                            <label class="col-md-6 col-form-label">MotorRPM</label>
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="MotorRPM" value="1400" style="color: blue;" />
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Output Section -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">Outputs</div>
                <div class="card-body">
                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">Weight (KG)</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="weight" value="0" style="color: blue;" />
                        </div>
                    </div>

                    <br>

                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">Power (Wat)</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="power" value="0" style="color: blue;" />
                        </div>
                    </div>
                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">MotorTorq (N.m)</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="MotorTorq" value="0" style="color: blue;" />
                        </div>
                    </div>
                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">MotorTorqLimiter (N.m)</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="MotorTorqLimiter" value="0" style="color: blue;" />
                        </div>
                    </div>

                    <br>

                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">Speed (RPM)</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="speed" value="0" style="color: blue;" />
                        </div>
                    </div>
                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">GearboxTorq (N.m)</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="GearboxTorq" value="0" style="color: blue;" />
                        </div>
                    </div>
                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">GearboxRatio</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="GearboxRatio" value="0" style="color: blue;" />
                        </div>
                    </div>

                    <br>

                    <div class="mb-1 row">
                        <label class="col-md-6 col-form-label">Capacity (M3/h)</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" readonly name="Capacity" value="0" style="color: blue;" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Picture Section -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">Picture</div>
                <div class="card-body d-flex justify-content-center align-items-center" style="height: 220px;">
                    <img src="#" alt="Diagram" class="preview-img" />
                </div>
            </div>
        </div>
    </div>

    <!-- Spinner for Calculate -->
    <div class="text-center mt-2">
        <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Buttons -->
    <div class="text-center mt-4">
        <button id="calculatebtn" class="btn btn-primary me-3">Calculate</button>
        <button id="reportbtn" class="btn btn-secondary me-3" onclick="generateWord()">Report</button>
        <button id="Drawing1" class="btn btn-success" onclick="downloadDXF()">AutoCAD General Drawing</button>
    </div>
</div>

<!-- Additional JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.0/docx.umd.min.js"></script>
<script>
    document.getElementById('calculatebtn').addEventListener('click', async function () {
        const apiUrl = "https://us-central1-h1000project1.cloudfunctions.net/f01";
        const reqType = "BC";
        const spinner = document.getElementById('loadingSpinner');
        spinner.style.display = 'inline-block';

        const inputData = {
            BC_Length:    parseFloat(document.querySelector('input[name="beltlength"]').value),
            BC_Width:     parseFloat(document.querySelector('input[name="beltwidth"]').value),
            BC_DrumDia:   parseFloat(document.querySelector('input[name="drumdiameter"]').value),
            BC_Friction:  parseFloat(document.querySelector('input[name="friction"]').value),
            BC_Velocity:  parseFloat(document.querySelector('input[name="velocity"]').value),
            BC_FOS:       parseFloat(document.querySelector('input[name="factorofsafety"]').value),
            BC_Belt_weight_per_meter: parseFloat(document.querySelector('input[name="beltweightpermeter"]').value),
            BC_MotorRPM: parseFloat(document.querySelector('input[name="MotorRPM"]').value),
        };

        const payload = { reqType, ...inputData };

        try {
            const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error(`API error: ${response.statusText}`);
            const result = await response.json();
            document.querySelector('input[name="weight"]').value        = result.O_Weight || "0";
            document.querySelector('input[name="power"]').value         = result.O_Power || "0";
            document.querySelector('input[name="MotorTorq"]').value     = result.MotorTorq || "0";
            document.querySelector('input[name="MotorTorqLimiter"]').value = result.MotorTorqLimiter || "0";
            document.querySelector('input[name="speed"]').value       = result.SpeedRPM || "0";
            document.querySelector('input[name="GearboxTorq"]').value       = result.GearBox_Torq || "0";
            document.querySelector('input[name="GearboxRatio"]').value       = result.GearBox_Ratio || "0";
            document.querySelector('input[name="Capacity"]').value       = result.Capacity || "0";
        } catch (error) {
            console.error("API Error:", error);
            alert("Failed to fetch result.");
        } finally {
            spinner.style.display = 'none';
        }

        const apiUrl2 = "https://function-googlesheet-190014287304.europe-west1.run.app";
        const oStrType = "BC";

        const inputData2 = {
            oStrIn:
                "beltlength: " +
                parseFloat(document.querySelector('input[name="beltlength"]').value).toString() +
                ", beltwidth: " +
                parseFloat(document.querySelector('input[name="beltwidth"]').value).toString() +
                ", drumdiameter:" +
                parseFloat(document.querySelector('input[name="drumdiameter"]').value).toString() +
                ", friction:" +
                parseFloat(document.querySelector('input[name="friction"]').value).toString() +
                ", velocity:" +
                parseFloat(document.querySelector('input[name="velocity"]').value).toString() +
                ", factorofsafety:" +
                parseFloat(document.querySelector('input[name="factorofsafety"]').value).toString() +
                ", beltweightpermeter:" +
                parseFloat(document.querySelector('input[name="beltweightpermeter"]').value).toString(),
            oStrOut:
                "weight: " +
                parseFloat(document.querySelector('input[name="weight"]').value).toString() +
                ", power: " +
                parseFloat(document.querySelector('input[name="power"]').value).toString() +
                ", speed: " +
                parseFloat(document.querySelector('input[name="speed"]').value).toString(),
        };

        const payload2 = { oStrType, ...inputData2 };

        try {
            const response = await fetch(apiUrl2, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload2),
            });
        } catch (error) {
            console.error("API Error:", error);
        }
    });

    async function downloadDXF() {
        const spinner = document.getElementById('loadingSpinner');
        spinner.style.display = "block";

        const beltlength = document.getElementsByName('beltlength')[0].value;
        const beltwidth = document.getElementsByName('beltwidth')[0].value;

        const url = `https://f020-190014287304.us-central1.run.app/?varA=${encodeURIComponent(beltlength)}&varB=${encodeURIComponent(beltwidth)}`;

        // Open the URL in a new tab
        window.open(url, '_blank');

        // Stop spinner right after tab opens
        spinner.style.display = "none";

        // Logging to Google Sheets
        const apiUrl2 = "https://function-googlesheet-190014287304.europe-west1.run.app";
        const oStrType = "BC";

        const inputData2 = {
            oStrIn: "beltlength: " + parseFloat(beltlength).toString() +
                    ", beltwidth: " + parseFloat(beltwidth).toString(),
            oStrOut: "Drawing"
        };

        const payload2 = { oStrType, ...inputData2 };

        try {
            const response = await fetch(apiUrl2, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload2),
            });

            if (!response.ok) {
                console.error("Logging failed:", await response.text());
            }
        } catch (error) {
            console.error("API Error:", error);
        }
    }

    // Generate Word Document
    async function generateWord() {
        const {
            Document, Packer, Paragraph, TextRun,
            Table, TableRow, TableCell, WidthType
        } = window.docx;

        const doc = new Document({
            sections: [{
                properties: {},
                children: [
                    new Paragraph({
                        children: [new TextRun({
                            text: "Belt Conveyor Calculation Summary",
                            bold: true,
                            color: "2E74B5",
                            size: 28
                        })]
                    }),
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "4472C4" },
                                        children: [new Paragraph(new TextRun({ text: "Parameter", bold: true, color: "FFFFFF" }))]
                                    }),
                                    new TableCell({
                                        shading: { fill: "4472C4" },
                                        children: [new Paragraph(new TextRun({ text: "Value", bold: true, color: "FFFFFF" }))]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Belt Length")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="beltlength"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Belt Width")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="beltwidth"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Drum Diameter")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="drumdiameter"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Friction")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="friction"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Velocity")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="velocity"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Factor of Safety")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="factorofsafety"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Belt weight per meter")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="beltweightpermeter"]').value)]
                                    }),
                                ]
                            }),
                        ]
                    }),

                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "4472C4" },
                                        children: [new Paragraph(new TextRun({ text: "Result", bold: true, color: "FFFFFF" }))]
                                    }),
                                    new TableCell({
                                        shading: { fill: "4472C4" },
                                        children: [new Paragraph(new TextRun({ text: "Value", bold: true, color: "FFFFFF" }))]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Weight (KG)")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="weight"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Power (Wat)")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="power"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Speed (RPM)")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="speed"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("MotorTorq (N.m)")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="MotorTorq"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("MotorTorqLimiter (N.m)")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="MotorTorqLimiter"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("GearboxTorq (N.m)")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="GearboxTorq"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("GearboxRatio")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="GearboxRatio"]').value)]
                                    }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph("Capacity (M3/h)")]
                                    }),
                                    new TableCell({
                                        shading: { fill: "D9E1F2" },
                                        children: [new Paragraph(document.querySelector('input[name="Capacity"]').value)]
                                    }),
                                ]
                            }),
                        ]
                    })
                ]
            }]
        });

        const blob = await Packer.toBlob(doc);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Belt_Conveyor.docx";
        link.click();
    }
</script>

<style>
    .preview-img {
        max-width: 100%;
        max-height: 200px;
    }

    .btn {
        min-width: 120px;
    }

    input.form-control {
        color: blue;
    }

    .data-name {
        font-weight: 500;
        padding-top: 0.4rem;
    }
</style>
{% endblock %}