{% extends 'base.html' %}

{% block title %}Rectangular Tanks - My Project{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4 text-center">Mechanical Screen</h1>

    <div class="row">
      <!-- Input Section -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">Inputs</div>
          <div class="card-body">
            <form id="inputForm">
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Channel Height (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="channelheight" value="1000" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Screen Width (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="screenwidth" value="1000" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Belt Height (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="beltheight" value="1000" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Water Level (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="waterlevel" value="600" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Bar Spacing (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="barspacing" value="25" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Bar Th (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="barth" value="10" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Bar Width (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="barwidth" value="50" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Inclination Degree (Deg)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="inclinationdegree" value="70" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Sprocket Diameter (mm)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="sprocketdiameter" value="320" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Velocity (m/s)</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="velocity" value="0.06" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">Safety Factor</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="safetyfactor" value="1.5" />
                </div>
              </div>
              <div class="mb-1 row">
                <label class="col-md-6 col-form-label">MotorRPM</label>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="MotorRPM" value="1400" />
                </div>
              </div>
              
            </form>
          </div>
        </div>
      </div>

      <!-- Output Section -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">Outputs</div>
          <div class="card-body">
            <div class="mb-1 row">
              <label class="col-md-6 col-form-label">Weight of Screen (kg)</label>
              <div class="col-md-6">
                <input type="text" class="form-control" readonly name="weightofscreen" value="0" />
              </div>
            </div>

            <br>
            
            <div class="mb-1 row">
              <label class="col-md-6 col-form-label">MotorPower (Wat)</label>
              <div class="col-md-6">
                <input type="text" class="form-control" readonly name="powerrequired" value="0" />
              </div>
            </div>
            <div class="mb-1 row">
              <label class="col-md-6 col-form-label">MotorTorq (N.m)</label>
              <div class="col-md-6">
                <input type="text" class="form-control" readonly name="MotorTorq" value="0" />
              </div>
            </div>
            <div class="mb-1 row">
              <label class="col-md-6 col-form-label">MotorTorqLimiter (N.m)</label>
              <div class="col-md-6">
                <input type="text" class="form-control" readonly name="MotorTorqLimiter" value="0" />
              </div>
            </div>

            <br>
            
            <div class="mb-1 row">
              <label class="col-md-6 col-form-label">Gearmotor Speed (RPM)</label>
              <div class="col-md-6">
                <input type="text" class="form-control" readonly name="speedofmotor" value="0" />
              </div>
            </div>
            <div class="mb-1 row">
              <label class="col-md-6 col-form-label">GearboxTorq (N.m)</label>
              <div class="col-md-6">
                <input type="text" class="form-control" readonly name="GearboxTorq" value="0" />
              </div>
            </div>
            <div class="mb-1 row">
              <label class="col-md-6 col-form-label">GearboxRatio</label>
              <div class="col-md-6">
                <input type="text" class="form-control" readonly name="GearboxRatio" value="0" />
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Picture Section -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">Picture</div>
          <div class="card-body d-flex justify-content-center align-items-center" style="height: 220px;">
            <img src="#" alt="Diagram" class="preview-img" />
          </div>
        </div>
      </div>
    </div>

    <!-- Spinner for Calculate -->
        <div class="text-center mt-2">
          <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

    <!-- Buttons -->
    <div class="text-center mt-4">
      <button id="calculatebtn" class="btn btn-primary me-3">Calculate</button>
      
      <button id="reportbtn" class="btn btn-secondary" onclick="generateWord()">Report</button>
      <button id="Drawing1" class="btn btn-success " onclick="downloadDXF()">AutoCAD General Drawing</button>

      
    </div>
  </div>
  <br>
  <br>



  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.0/docx.umd.min.js"></script>



  <script>
    async function downloadDXF() {
      const varA = document.getElementsByName('channelheight')[0].value;
      const varB = document.getElementsByName('screenwidth')[0].value;
      const varC = document.getElementsByName('barth')[0].value;
      const varD = document.getElementsByName('barspacing')[0].value;
      const spinner = document.getElementById('loadingSpinner');

      spinner.style.display = "block";

      const url = `https://f030-190014287304.europe-west1.run.app/?varA=${encodeURIComponent(varA)}&varB=${encodeURIComponent(varB)}&varC=${encodeURIComponent(varC)}&varD=${encodeURIComponent(varD)}`;

      // Open the URL in a new tab
      window.open(url, '_blank');

      // Stop spinner immediately after opening new tab
      spinner.style.display = "none";

      // --- Logging to Google Sheets ---
      const apiUrl2 = "https://function-googlesheet-190014287304.europe-west1.run.app";
      const oStrType = "MS";

      const inputData2 = {
        oStrIn: "channelheight: " + parseFloat(varA) +
                ", screenwidth: " + parseFloat(varB) +
                ", barth: " + parseFloat(varC) +
                ", barspacing: " + parseFloat(varD),
        oStrOut: "Drawing"
      };

      const payload2 = { oStrType, ...inputData2 };

      try {
        const response = await fetch(apiUrl2, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload2),
        });

        if (!response.ok) {
          console.error("Logging failed:", await response.text());
        }

      } catch (error) {
        console.error("API Error:", error);
        alert("Failed to log the request.");
      }
    }
  </script>

  
  


  <script>

    document.getElementById('calculatebtn').addEventListener('click', async function () {
      const apiUrl = "https://us-central1-h1000project1.cloudfunctions.net/f01";
      const reqType = "MS";
      const spinner = document.getElementById('loadingSpinner');
      spinner.style.display = 'inline-block';

      const inputData = {
        MS_ChannelHeight:     parseFloat(document.querySelector('input[name="channelheight"]').value),
        MS_ScreenWidth:       parseFloat(document.querySelector('input[name="screenwidth"]').value),
        MS_BeltHeight:        parseFloat(document.querySelector('input[name="beltheight"]').value),
        MS_WaterLevel:        parseFloat(document.querySelector('input[name="waterlevel"]').value),
        MS_BarSpacing:        parseFloat(document.querySelector('input[name="barspacing"]').value),
        MS_BarThickness:      parseFloat(document.querySelector('input[name="barth"]').value),
        MS_BarWidth:          parseFloat(document.querySelector('input[name="barwidth"]').value),
        MS_InclinationDegree: parseFloat(document.querySelector('input[name="inclinationdegree"]').value),
        MS_SprocketDiameter:  parseFloat(document.querySelector('input[name="sprocketdiameter"]').value),
        MS_Velocity:          parseFloat(document.querySelector('input[name="velocity"]').value),
        MS_FOS:               parseFloat(document.querySelector('input[name="safetyfactor"]').value),
        MS_MotorRPM:               parseFloat(document.querySelector('input[name="MotorRPM"]').value),
      };

      const payload = { reqType, ...inputData };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error(`API error: ${response.statusText}`);
        const result = await response.json();
        document.querySelector('input[name="weightofscreen"]').value    = result.O_Weight || "0";
        document.querySelector('input[name="powerrequired"]').value     = result.O_Power || "0";
        document.querySelector('input[name="MotorTorq"]').value         = result.MotorTorq || "0";
        document.querySelector('input[name="MotorTorqLimiter"]').value  = result.MotorTorqLimiter || "0";
        document.querySelector('input[name="speedofmotor"]').value      = result.O_MotorSpeed || "0";
        document.querySelector('input[name="GearboxTorq"]').value       = result.GearBox_Torq || "0";
        document.querySelector('input[name="GearboxRatio"]').value      = result.GearBox_Ratio || "0";
      } catch (error) {
        console.error("API Error:", error);
        alert("Failed to fetch result.");
        alert(error.message);
      } finally {
        spinner.style.display = 'none';
      }





      const apiUrl2 = "https://function-googlesheet-190014287304.europe-west1.run.app";
      const oStrType = "MS";

      const inputData2 = {
        oStrIn:
          "channelheight: " +
          parseFloat(document.querySelector('input[name="channelheight"]').value).toString() +
          ", screenwidth: " +
          parseFloat(document.querySelector('input[name="screenwidth"]').value).toString() +
          ", beltheight:" +
          parseFloat(document.querySelector('input[name="beltheight"]').value).toString() +
          ", waterlevel:" +
          parseFloat(document.querySelector('input[name="waterlevel"]').value).toString() +
          ", barspacing:" +
          parseFloat(document.querySelector('input[name="barspacing"]').value).toString() +
          ", barth:" +
          parseFloat(document.querySelector('input[name="barth"]').value).toString() +
          ", barwidth:" +
          parseFloat(document.querySelector('input[name="barwidth"]').value).toString() +
          ", inclinationdegree:" +
          parseFloat(document.querySelector('input[name="inclinationdegree"]').value).toString() +
          ", sprocketdiameter:" +
          parseFloat(document.querySelector('input[name="sprocketdiameter"]').value).toString() +
          ", velocity:" +
          parseFloat(document.querySelector('input[name="velocity"]').value).toString() +
          ", safetyfactor:" +
          parseFloat(document.querySelector('input[name="safetyfactor"]').value).toString(),
        oStrOut:
          "weightofscreen: " +
          parseFloat(document.querySelector('input[name="weightofscreen"]').value).toString() +
          ", powerrequired: " +
          parseFloat(document.querySelector('input[name="powerrequired"]').value).toString() +
          ", speedofmotor" +
          parseFloat(document.querySelector('input[name="speedofmotor"]').value).toString(),
        
      };

      const payload2 = { oStrType, ...inputData2 };

      try {
        const response = await fetch(apiUrl2, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload2),
        });

      } catch (error) {
        console.error("API Error:", error);
        alert("Failed to fetch result.");
      } 



    });

  </script>

  <!-- WORD FILE -->
    <script src="https://unpkg.com/docx@8.4.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      // Generate Word Document
      async function generateWord() {
        const {
          Document, Packer, Paragraph, TextRun,
          Table, TableRow, TableCell, WidthType
        } = window.docx;

        const doc = new Document({
          sections: [{
            properties: {},
            children: [
              new Paragraph({
                children: [new TextRun({
                  text: "Mechanical Screen Calculation Summary",
                  bold: true,
                  color: "2E74B5",
                  size: 28
                })]
              }),
              new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "4472C4" },
                        children: [new Paragraph(new TextRun({ text: "Header 1", bold: true, color: "FFFFFF" }))]
                      }),
                      new TableCell({
                        shading: { fill: "4472C4" },
                        children: [new Paragraph(new TextRun({ text: "Header 2", bold: true, color: "FFFFFF" }))]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Channel Height (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="channelheight"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Screen Width (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="screenwidth"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Belt Height (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="beltheight"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Water Level (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="waterlevel"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Bar Spacing (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="barspacing"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Bar Th (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="barth"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Bar Width (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="barwidth"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Inclination Degree (Deg)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="inclinationdegree"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Sprocket Diameter (mm)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="sprocketdiameter"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Velocity (m/s)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="velocity"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Safety Factor")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="safetyfactor"]').value)]
                      }),
                    ]
                  }),
                ]
              }),

              new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "4472C4" },
                        children: [new Paragraph(new TextRun({ text: "Header 1", bold: true, color: "FFFFFF" }))]
                      }),
                      new TableCell({
                        shading: { fill: "4472C4" },
                        children: [new Paragraph(new TextRun({ text: "Header 2", bold: true, color: "FFFFFF" }))]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Weight of Screen (kg)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="weightofscreen"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Power Required (Wat)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="powerrequired"]').value)]
                      }),
                    ]
                  }),
                  new TableRow({
                    children: [
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph("Speed of motor (RPM)")]
                      }),
                      new TableCell({
                        shading: { fill: "D9E1F2" },
                        children: [new Paragraph(document.querySelector('input[name="speedofmotor"]').value)]
                      }),
                    ]
                  }),
                ]
              })

            ]
          }]
        });

        const blob = await Packer.toBlob(doc);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Mechanical_Screen.docx";
        link.click();
      }

      
    </script>
{% endblock %}